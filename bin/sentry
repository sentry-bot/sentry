#!/usr/bin/env ruby

require 'thor'
require 'daemons'
require 'eventmachine'
require 'sentry'

class SentryRunner < Thor
  default_task :help

  desc "start", "start the bot"
  def start
    # Prepare the daemon
    Daemons.daemonize(
      :app_name => "sentry",
      :dir_mode => :normal,
      :log_dir => File.join(File.dirname(File.dirname(__FILE__)), 'logs'),
      :log_output => true,
      :dir => File.join('/', 'tmp')
    )

    # Get the bot
    bot = Sentry.new

    EM.run {
      # Stop when requested
      Signal.trap('INT') { EM.stop }
      Signal.trap('TERM'){ EM.stop }

      # Start the bot
      EM.defer { bot.start }
    }

    # Exit the bot
    bot.quit
  end

  desc "stop", "stop the bot"
  def stop
    pid_file = File.join("/", "tmp", "sentry.pid")
    pid = File.read(pid_file).to_i if File.exist?(pid_file)
    Process.kill('TERM', pid) if not pid.nil?
  end

  desc "restart", "restart the bot"
  def restart
    stop
    start
  end
end

SentryRunner.start